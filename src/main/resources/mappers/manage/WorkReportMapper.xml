<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gms.web.admin.mapper.manage.WorkReportMapper">
	<resultMap id="WorkReportMap" type="com.gms.web.admin.domain.manage.WorkReportVO" >
		<result property="workReportSeq"		column="Work_Report_Seq"		/>
		<result property="userId"				column="User_ID"				/>
		<result property="customerId"			column="Customer_ID"			/>
		<result property="customerNm"			column="Customer_NM"			/>
		<result property="orderId"				column="Order_ID"				/>
		<result property="workProductNm"		column="Work_Product_NM"		/>
		<result property="workProductCapa"		column="Work_Product_Capa"		/>
		<result property="workCd"				column="Work_CD"				/>
		<result property="workCdNm"				column="Work_CD_NM"				/>
		<result property="workDt"				column="Work_Dt"				/>
		<result property="orderAmount"			column="Order_Amount"			/>
		<result property="receivedAmount"		column="Received_Amount"		/>
		<result property="orderProductNm"		column="Order_Product_Nm"		/>		
		<result property="orderProductCapa"		column="Order_Product_Capa"		/>
		<result property="bottleType"			column="Bottle_Type"			/>
		<result property="createNm"				column="Create_Nm"				/>
		<result property="orderProcessCd"		column="Order_Process_CD"		/>
		<result property="orderProcessCdNm"		column="Order_Process_CD_NM"	/>
		<result property="createId"				column="CREATE_ID"				/>
		<result property="createDt"				column="CREATE_DT"				/>
		<result property="updateId"				column="UPDATE_ID"				/>		
		<result property="updateDt"				column="UPDATE_DT"				/>
	</resultMap>	

	<resultMap id="WorkBottleMap" type="com.gms.web.admin.domain.manage.WorkBottleVO" >
		<result property="workReportSeq"		column="Work_Report_Seq"		/>				
		<result property="bottleId"				column="Bottle_ID"				/>
		<result property="bottleBarCd"			column="Bottle_BarCd"			/>		
		<result property="customerId"			column="Customer_ID"			/>
		<result property="customerNm"			column="Customer_NM"			/>
		<result property="bottleWorkCd"			column="Bottle_Work_CD"			/>
		<result property="gasID"				column="Gas_ID"					/>
		<result property="productId"			column="Product_ID"				/>
		<result property="productPriceSeq"		column="Product_Price_Seq"		/>
		<result property="bottleType"			column="Bottle_Type"			/>
		<result property="createId"				column="CREATE_ID"				/>
		<result property="createDt"				column="CREATE_DT"				/>
		<result property="updateId"				column="UPDATE_ID"				/>		
		<result property="updateDt"				column="UPDATE_DT"				/>	
	</resultMap>
	
	<sql id="WorkReportColumns">
		Work_Report_Seq
		 , User_ID
		 , Customer_ID
		 , Order_ID
		 , Work_Product_NM
		 , Work_Product_Capa
		 , Work_CD
		 , Work_Dt
		 , Received_Amount
		 , Bottle_Type
		 , Create_ID        
		 , Create_Dt        
		 , Update_ID        
		 , Update_Dt   
	</sql>
	<sql id="SelectWorkReportColumns">
		 Work_Report_Seq
		 , User_ID
		 , tw.Customer_ID
		 , (SELECT Customer_Nm FROM TB_Customer Where Customer_ID= tw.Customer_Id) Customer_NM
		 , tw.Order_ID
		 , Work_Product_NM
		 , Work_Product_Capa
		 , Work_CD
		 , CD_NM Work_CD_NM
		 , Work_Dt
		 , Order_Total_Amount Order_Amount
		 , Received_Amount
		 , Bottle_Type
		 , Order_Product_Nm
		 , Order_Product_Capa
		 , Order_Process_CD 
		 , (SELECT CD_NM FROM TB_Code Where Cd_ID= Order_Process_CD) Order_Process_CD_NM
		 , tw.Create_ID        
		 , tw.Create_Dt        
		 , tw.Update_ID        
		 , tw.Update_Dt     
	</sql>
	<sql id="WorkBottleColumns">
		 Work_Report_Seq
		 , Bottle_ID
		 , Bottle_BarCd       
		 , Customer_ID         
		 , Bottle_Work_Cd      
		 , Gas_ID              
		 , Product_ID          
		 , Product_Price_Seq   
		 , Bottle_Type
		 , Create_ID        
		 , Create_Dt        
		 , Update_ID        
		 , Update_Dt   
	</sql>
	
	<insert id="insertWorkReport" parameterType="com.gms.web.admin.domain.manage.WorkReportVO">
		INSERT INTO TB_Work_Report(
			<include refid="WorkReportColumns" />
		) VALUES (
			#{workReportSeq}
			, #{userId}
			, #{customerId}	
			, #{orderId}	
			, #{workProductNm}	
			, #{workProductCapa}	
			, #{workCd}	
			, NOW()	
			, #{receivedAmount}		
			, #{bottleType}
			, #{createId}			
			, NOW()
			, NULL
			, NOW()
		)
	</insert>
	
	<insert id="insertWorkBottle" parameterType="com.gms.web.admin.domain.manage.WorkBottleVO">
		INSERT INTO TB_Work_Bottle(
			<include refid="WorkBottleColumns" />
		) VALUES (
			#{workReportSeq}
			, #{bottleId}	
			, #{bottleBarCd}	
			, #{customerId}	
			, #{bottleWorkCd}	
			, #{gasId}				
			, #{productId}	
			, #{productPriceSeq}
			, #{bottleType}
			, #{createId}			
			, NOW()
			, NULL
			, NOW()
		)
	</insert>
	
	<insert id="insertWorkBottles" parameterType="java.util.List">
		INSERT INTO TB_Work_Bottle(
			<include refid="WorkBottleColumns" />
		) VALUES 
		<foreach collection="list" item="item" separator=" , ">
		(
			#{item.workReportSeq}
			, #{item.bottleId}	
			, #{item.bottleBarCd}	
			, #{item.customerId}	
			, #{item.bottleWorkCd}	
			, #{item.gasId}				
			, #{item.productId}	
			, #{item.productPriceSeq}
			, #{item.bottleType}
			, #{item.createId}			
			, NOW()
			, NULL
			, NOW()
		)
		</foreach>
	</insert>
	
	<insert id="insertWorkReportList" parameterType="java.util.List">
		INSERT INTO TB_Work_Bottle(
			<include refid="WorkBottleColumns" />
		) VALUES 
		<foreach collection="list" item="item" separator=" , ">
		(
			#{item.workReportSeq}
			, #{item.bottleId}	
			, #{item.bottleBarCd}	
			, #{item.customerId}	
			, #{item.bottleWorkCd}
			, #{item.gasID}				
			, #{item.productId}	
			, #{item.productPriceSeq}			
			, #{item.bottleType}
			, #{item.createId}			
			, NOW()
			, NULL
			, NOW()
		)
		</foreach>
	</insert>
	
	<select id="selectWorkReportList" resultType="com.gms.web.admin.domain.manage.WorkReportVO" parameterType="com.gms.web.admin.domain.manage.WorkReportVO">		
		SELECT
			<include refid="SelectWorkReportColumns" />
		FROM
			TB_CODE td , TB_Work_Report tw Left Join  TB_Order tr on tw.Order_ID = tr.Order_ID
		WHERE
			User_id = #{userId}
		AND 
			tw.Work_CD = td.CD_ID
		<if test="@com.gms.web.admin.common.utils.StringUtils@isNotEmpty(searchDt)">
		AND DATE_FORMAT(Work_Dt,'%Y/%m/%d')  =   #{searchDt}
		</if>
		ORDER BY Work_Report_Seq DESC 
	</select>
	
	<select id="selectWorkReportSeq" resultType="int">
		SELECT IFNULL(A.Work_Report_Seq, 0)+1
		FROM 
		(
			SELECT max(Work_Report_Seq) Work_Report_Seq
			FROM TB_Work_Report   ) A
	</select>
	
	
	<select id="selectWorBottleListTotal" resultType="com.gms.web.admin.domain.manage.BottleVO" parameterType="java.util.Map">
		SELECT C.*
		FROM (
			SELECT A.*, B.Customer_Nm
			FROM (
				SELECT
					TWB.Bottle_ID
					, TWB.Bottle_BarCd
					, TWB.Product_ID
					, TWB.Product_Price_Seq
					, TWB.Gas_ID	
					, Product_Nm
					, Bottle_Capa
					, Bottle_Volumn
					, TWB.Bottle_Work_CD
					, USER_ID Bottle_Work_ID
					, TWB.Customer_ID
					, TB.Member_Comp_Seq	
					, TW.Order_ID
					, Order_Product_Seq	
					, TWB.Bottle_Type
					, Work_DT Bottle_Work_DT
					, TW.CREATE_ID
					, TW.CREATE_DT
					, TW.UPDATE_ID
					, TW.UPDATE_DT
					, CD_NM Bottle_Work_CD_NM
				FROM
					TB_Work_Bottle TWB,TB_Work_Report TW, TB_Bottle TB, TB_CODE TC, TB_Product TG
				WHERE
					TB.Delete_YN = 'N'			
				AND 
					TWB.`Work_Report_Seq` = TW.`Work_Report_Seq`
				AND 
					TWB.`Bottle_ID` = TB.`Bottle_ID`
				AND 
					TWB.Bottle_Work_CD = TC.CD_ID	
				AND 
					TWB.Product_ID = TG.Product_Id
			) A left outer join TB_Customer B on A.Customer_ID = B.Customer_ID	
		) C
		WHERE 1 = 1
		<if test="@com.gms.web.admin.common.utils.StringUtils@isNotEmpty(searchCustomerNm)">
		AND Customer_Nm	 LIKE CONCAT('%', CONCAT(#{searchCustomerNm}, '%'))
		</if>				
		<if test="@com.gms.web.admin.common.utils.StringUtils@isNotEmpty(searchChargeDt)">
		AND date_format(Bottle_Work_DT,'%Y/%m/%d')  between  #{searchChargeDtFrom} AND  #{searchChargeDtEnd} 
		</if>										
		ORDER BY Bottle_Work_DT DESC 
		Limit #{startRow}, #{rowPerPage}
	</select>
	
	
	<select id="selectWorBottleCountTotal" resultType="int" parameterType="java.util.Map">		
		SELECT Count(Bottle_ID)
		FROM (
			SELECT A.*, B.Customer_Nm
			FROM (
				SELECT
					TWB.Bottle_ID
					, TWB.Bottle_BarCd
					, TWB.Product_ID
					, TWB.Product_Price_Seq
					, TWB.Gas_ID	
					, Product_Nm
					, Bottle_Capa
					, Bottle_Volumn
					, TWB.Bottle_Work_CD
					, USER_ID Bottle_Work_ID
					, TWB.Customer_ID
					, TB.Member_Comp_Seq	
					, TW.Order_ID
					, Order_Product_Seq	
					, TWB.Bottle_Type
					, Work_DT Bottle_Work_DT
					, TW.CREATE_ID
					, TW.CREATE_DT
					, TW.UPDATE_ID
					, TW.UPDATE_DT
					, CD_NM Bottle_Work_CD_NM
				FROM
					TB_Work_Bottle TWB,TB_Work_Report TW, TB_Bottle TB, TB_CODE TC, TB_Product TG
				WHERE
					TB.Delete_YN = 'N'			
				AND 
					TWB.`Work_Report_Seq` = TW.`Work_Report_Seq`
				AND 
					TWB.`Bottle_ID` = TB.`Bottle_ID`
				AND 
					TWB.Bottle_Work_CD = TC.CD_ID	
				AND 
					TWB.Product_ID = TG.Product_Id
			) A left outer join TB_Customer B on A.Customer_ID = B.Customer_ID	
		) C
		WHERE 1 = 1
		<if test="@com.gms.web.admin.common.utils.StringUtils@isNotEmpty(searchCustomerNm)">
		AND Customer_Nm	 LIKE CONCAT('%', CONCAT(#{searchCustomerNm}, '%'))
		</if>				
		<if test="@com.gms.web.admin.common.utils.StringUtils@isNotEmpty(searchChargeDt)">
		AND date_format(Bottle_Work_DT,'%Y/%m/%d')  between  #{searchChargeDtFrom} AND  #{searchChargeDtEnd} 
		</if>								
	</select>
	
	<select id="selectWorBottleListToday" resultType="com.gms.web.admin.domain.manage.BottleVO">		
		SELECT A.*, B.Customer_Nm
		FROM (
			SELECT
				TWB.Bottle_ID
				, TWB.Bottle_BarCd
				, TWB.Product_ID
				, TWB.Product_Price_Seq
				, TWB.Gas_ID	
				, Product_Nm
				, Bottle_Capa
				, Bottle_Volumn
				, TWB.Bottle_Work_CD
				, USER_ID Bottle_Work_ID
				, TWB.Customer_ID
				, TB.Member_Comp_Seq	
				, TW.Order_ID
				, Order_Product_Seq	
				, TWB.Bottle_Type
				, Work_DT Bottle_Work_DT
				, TW.CREATE_ID
				, TW.CREATE_DT
				, TW.UPDATE_ID
				, TW.UPDATE_DT
				, CD_NM Bottle_Work_CD_NM
			FROM
				TB_Work_Bottle TWB,TB_Work_Report TW, TB_Bottle TB, TB_CODE TC, TB_Product TG
			WHERE
				TB.Delete_YN = 'N'		
			AND 
				DATE_FORMAT(Work_Dt,'%Y/%m/%d') = DATE_FORMAT(curdate(),'%Y/%m/%d')	
			AND 
				TWB.`Work_Report_Seq` = TW.`Work_Report_Seq`
			AND 
				TWB.`Bottle_ID` = TB.`Bottle_ID`
			AND 
				TWB.Bottle_Work_CD = TC.CD_ID	
			AND 
				TWB.Product_ID = TG.Product_Id
		) A left outer join TB_Customer B on A.Customer_ID = B.Customer_ID	
		ORDER BY Bottle_Work_DT DESC 
	</select>
</mapper>