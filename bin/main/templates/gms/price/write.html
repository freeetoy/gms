<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="gms/layout/basic">

<div class="wrapper">

<th:block layout:fragment="content"> 
<script type="text/javascript">


function validationOfForm(form) {
	
	var priceCnt= $("#priceCnt").val() ;
	alert("priceCnt==="+priceCnt);
	if($("#productId_0").val() == "0" || $("#productCapa_0").val() == "0" || $("#productprice_0").val() == ""){
		alert("document.mainForm.customerId.value== "+document.mainForm.customerId.value );
		alert('상품을 선택 하세요');      
		return false;
	}
	
	//var customerId= document.mainForm.
	
}
// end of function



//Ajax공통 호출
function callAjax(ajaxInfo){
	var dfd = $.Deferred();
	$.ajax(ajaxInfo).done(function(data){
		dfd.resolve(data);
	});
	
	return dfd.promise();
}


var fn_modifyGas = function(gasId){

	var ajaxInfo ={
		type:"POST",
		url:"/gms/gas/detail.do",
		data:{
			gasId : gasId
		},
		dataType: "json",
	};
	
	ajax = callAjax(ajaxInfo);
	
	ajax.done(function(data){
		console.log(data);
	
		console.log("####gasCd---"+data.gasCd);		
		
		$("#gasId").val(data.gasId);
		$("#gasNm").val(data.gasNm);
		$("#gasCd").val(data.gasCd);
		//document.form1.gasNm1.value=data.gasNm;
			
		if(data.result == "fail"){
			alert("가스가 존재하지 않습니다");			
			return;
		}
		
	});

};


$(document).ready(function(){ 
	
	var counter = 0;
	
	init_add(0);
	$("#addrow").on("click", function () {

		alert("addrow");
		counter++;

		if (counter > 11){

		  alert('더 이상 추가 할수 없습니다.');
		  return false;

		}

		var newRow = $("<tr>");
		var cols = "";

		cols += '<td style="padding-left:0px;">';
		cols += '<select class="form-control" id="productId_' + counter +  '" name="productId_' + counter + '" style="width:160px"></select>'; 
		cols += '</td><td>';
		cols += ' <select class="form-control" id="productPriceSeq_' + counter + '" name="productPriceSeq_' + counter + '" style="width:100px"><option value=0>옵션</option></select> ';
		cols += '</td><td>';
		cols += ' <input type="text" class="form-control" id="productPrice_' + counter + '" name="productPrice_' + counter + '" " placeholder="가격">';
		cols += '</td><td>';  
		cols += ' <input type="button" class="ibtnDel btn btn-md btn-danger" id="addrow" value="삭제" />';
		cols += '</td>';
		cols +='</tr>';

		newRow.append(cols);
		$("table.doc-list").append(newRow);
		$("#priceCount").val(counter+1);
		init_add(counter);

		init_add_storage(counter);

	});

	// 품명 선택 변경

    $('#productId_0').change( function(){

		var select_pumname = $('#productId_0').val();

		init_storage_list(select_pumname,0,"ins");
	});



    //수정시 row 추가

     var mod_counter = 0;

    $("table.doc-list").on("click", ".ibtnAddMod", function (event) {
         
        console.log("추가 클릭");

        mod_counter++;       

        console.log("추가 mod_counter:" + mod_counter);

        var newRow = $("<tr>");
        var cols = "";

        cols += '<td style="padding-left:0px;">';
        cols += '<select class="form-control" id="productId_' + mod_counter +  '" name="productId_' + mod_counter + '" style="width:160px"></select>';
        cols += '</td><td>';
        cols += ' <select class="form-control" id="productPriceSeq_' + mod_counter + '" name="productPriceSeq_' + mod_counter + '" style="width:100px"></select> ';
		cols += '</td><td>';
        cols += '<input type="text" class="form-control" id="productPrice_' + mod_counter + '" name="productPrice_' + mod_counter + '">';
        cols += '</td><td>';
        cols += ' <input type="button" class="ibtnDelMod btn btn-md btn-danger" id="addrow" value="삭제" />';
        cols += '</td>';
        cols +='</tr>';

        newRow.append(cols);
        $("table.doc-list").append(newRow);

        $("#priceCount").val(mod_counter);
        init_add(mod_counter);

        init_mod_storage(mod_counter);


    });
    
    
    // row 삭제


    $("table.doc-list").on("click", ".ibtnDel", function (event) {
        $(this).closest("tr").remove();       
        console.log("ibtnDel mod_counter "+counter);
        counter -= 1
        
        $("#priceCount").val(counter);
    });




    $("table.doc-list").on("click", ".ibtnDelMod", function (event) {
        $(this).closest("tr").remove();       
        console.log("ibtnDelMod mod_counter "+mod_counter);
        mod_counter -= 1
        $("#priceCount").val(mod_counter);
    });
    

    function init_mod_storage(mod_counter) {
        // body...
      
           $('#productId_' + mod_counter).change( function(){      

          	var mod_select_pumname = $('#productId_' + mod_counter).val();

          	init_storage_list(mod_select_pumname,mod_counter,'mod');
        
          });

      }
    
    function init_add(pid){

        $.ajax({
  	  	url: '/gms/product/nlist.do',
  	  	type: 'POST',  	  	
  	  	dataType: 'json',

       })
  	 .done(function(data){
  		console.log(data);       
  		var i=0;
  		$('#productId_' + pid).append('<option value=0>상품</option>');
		for(i=0; i< data.length;i++) {
			console.log(data[i]);      
			$('#productId_' + pid).append('<option value='+data[i].productId+'>'+data[i].productNm+'</option>')
			
		}
  	  //var json_obj = $.parseJSON(data);//parse JSON
  	  
  	   // $('#productId_' + pid).find('option').remove(); 
  	    //$('#productId_' + pid).append(json_obj.productPriceList);	          
  	
       })
       .fail(function(){

  	console.log("fail");

       });

    } 
    
    
    function init_add_storage(counter) {
    	// body...

    		$('#productId_' + counter).change( function(){

    			var select_pumname = $('#productId_' + counter).val();

    			init_storage_list(select_pumname,counter,'ins');


    		});

    	}
    
 // 입력된 내용을 작성한다.
    $("#save").on("click", function () {
    	//validation();
    	
    	//var form1 = $("#mainForm");	
    	//var customerId =mainForm.customerId.val();
    	//alert("customerId="+customerId);
    	//if(!isOkay){
    	//	return;
    	//}
    	
    	var form = $("#writeForm");	
    	console.log(counter+mod_counter);
    	document.getElementById("priceCount").value = counter+mod_counter;
    	
    	form.submit();
    });
    
    function init_storage_list(pumname,sel_pid,type){
	      
		console.log(type);      
		
		$.ajax({
			url: '/gms/product/priceList.do',
			type: 'POST',
			data: 'productId='+ pumname ,
			dataType: 'json',

		 })
		.done(function(data){	           
		  //console.log("sel pid:" + sel_pid + "type:" + type);
			console.log(data);        

			//var json_obj = $.parseJSON(data);//parse JSON

			if(type == "ins"){
		    	var i=0;
				//$('#productCapa_' + sel_pid).find('option').remove(); 
				for(i=0; i< data.length;i++) {
					console.log(data[i]);      
					$('#productPriceSeq_' + sel_pid).append('<option value='+data[i].productPriceSeq+'>'+data[i].productCapa+'</option>')
					
				}
			}else if(type == "mod"){
				console.log("this is mod =="+sel_pid);
				$('#productPriceSeq_' + sel_pid).find('option').remove(); 
				for(i=0; i< data.length;i++) {
					console.log("tdata[i].productCapa =="+data[i].productCapa);
					$('#productPriceSeq_' + sel_pid).append('<option value='+data[i].productPriceSeq+'>'+data[i].productCapa+'</option>')
				//$('#productPriceSeq_' + sel_pid).append(json_obj.productPriceList);
				}
			}  		
		})
		.fail(function(){
			console.log("fail");
		 });

	} 

    
    
    
    $('select[name=customerId]').change(function() {
		
			$('#customerId1').val($(this).val());
			
			$.ajax({
				url: '/gms/price/customerList.do',
				type: 'POST',
				data: 'customerId='+ $(this).val() ,
				dataType: 'json',

			 })
			.done(function(data){	           
				var counter = 0;
		        var cols = "";
		        
				console.log("start datea ="+data);     
				for(i=0; i< data.length;i++) {
		            $('#productId_' + i).find('option').remove();
		        }
			

		    	var i=0;
				//$('#productCapa_' + sel_pid).find('option').remove(); 
				
				console.log("data.length "+data.length);     
				
				if(data.length ==0) {
					init_add(counter);
		            
		            init_mod_storage(counter);
		            
				}else {

				 	$("table.doc-list").find('tr').remove();
				 	
				 	var newRow = $("<tr>");
			        
			       	cols += '<td>상품</td>';
					cols += '<td>용량</td>';
					cols += '<td>가격</td>';
					cols += '<td></td></tr>';

			        newRow.append(cols);
			        $("table.doc-list").append(newRow);
			        
					for(i=0; i< data.length;i++) {
						console.log(data);     
						console.log(data[i]);     
						var newRow = $("<tr>");
				        
			            cols = "";
	
			            cols += '<td style="padding-left:0px;">';
			            cols += '<select class="form-control" id="productId_' + counter +  '" name="productId_' + counter + '" style="width:160px">' 
			            cols += '<option value="' + data[i].productId +'" selected>' + data[i].productNm + '</option>';
			            cols += '</select>';		          
			            cols += '</td><td>';
			            cols += ' <select class="form-control" id="productPriceSeq_' + counter + '" name="productPriceSeq_' + counter + '" style="width:100px">';
			            cols += '<option value="' + data[i].productPriceSeq +'" selected>' + data[i].productCapa + '</option>';
			            cols  += '</select> ';
			            cols += '</td><td>';
			            cols += ' <input type="text" id="productPrice_' + counter + '" name="productPrice_' + counter + '" class="form-control" value="' + data[i].productPrice + '">';		                         
			            cols += '</td><td>';		           
	
			            if (counter < 1){
	
			              cols += ' <input type="button" class="ibtnAddMod btn btn-md btn-info" id="mod_addrow" value="추가" />';
	
	
			            }else{
	
			              cols += ' <input type="button" class="ibtnDelMod btn btn-md btn-danger" id="addrow" value="삭제" />';
	
			            }
			            cols += '</td>';
			            cols +='</tr>';
	
			            newRow.append(cols);
			            $("table.doc-list").append(newRow);
			            
			            init_add(counter);
			            
			            init_mod_storage(counter);
			            
						console.log("counter=="+counter);   
	
			            mod_counter = counter;
	
			            counter++;
					}
				}
			})
			.fail(function(){
				console.log("fail");
			 });
			

	        //console.log("mod_counter:" + mod_counter);

	});
    
    
   
});

</script>

   <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>상품 등록</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">Simple Tables</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>
  
    <section class="content">   
        <div class="row">
    	
              <div class="col-1">
               		거래처명
              </div>               
              <div class="col-4">
              <form id="mainForm" name=""mainForm"" th:action="@{/gms/price/write.do}" method="post">
              <select id="customerId" name="customerId" class="form-control">
	                      <option value="0">거래처 목록</option>
	                    	<option th:each="row : ${customerList}"
				                th:text="${row.customerNm}"
				                th:value="${row.customerId}"
				               >
				     </option>		
			    </select>	   
			   </div>
              <div class="col-3">
              <input type="text" id="searchCustomerNm" name="searchCustomerNm" class="form-control" placeholder="search" th:value="${searchCustomerNm}">
              </div>               
              <div class="col-2">
                <button class="btn btn-navbar" type="submit">
            <i class="fas fa-search"></i>
          </button>
           </form>
              </div>
             
              <div class="col-2">
               		<a href="/gms/customer/write.do"><button type="button" class="btn btn-block btn-outline-primary btn-sm">거래처 등록</button></a>
              </div>
         </div>
         <div class="row">	
	        <div class="col-12">
	        <table class="table table-hover">
	         </table>
	        </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="card">
             
              
             <!-- general form elements -->                        
              <!-- /.card-header -->
              <div class="col-8">
              <form name="writeForm" id="writeForm" class="form-horizontal" th:action="@{/gms/price/register.do}"  method="post" onsubmit="return validationOfForm(this)">
              <input type="hidden" id="priceCount" name="priceCount" value="">
              <input type="hidden" id="customerId1" name="customerId1" value="">
                
                <div class="form-group">
                   <label class="control-label col-8">상품정보</label>
                   <div class="col-md-10 col-sm-10 col-xs-12">
                       <table id="myTable" class="table doc-list">
	                       <tr>
	                         <td>상품</td>
	                         <td>용량</td>
	                         <td>단가</td>
	                         <td></td>
	                       </tr>
	                       <tr>
	                       <td  style="padding-left: 0px;">                                           
	                         <select id="productId_0" name="productId_0" class="form-control" style="width:160px">
		                        
						    </select>	   
	                       </td>
	                       <td> 
	                       		<select id="productPriceSeq_0" name="productPriceSeq_0" class="form-control" style="width:100px">
			                        <option value="0">옵션</option>			                      	
							    </select>	   
	                        
	                       </td>   
	                       <td> 
	                         <input type="text" class="form-control" id="productPrice_0" name="productPrice_0" placeholder="가격">
	                       </td> 
	                       <td>
	                       <input type="button" class="btn btn-default btn-success" id="addrow" value="추가" />
	                       
	                       </td>
	                       </tr>
	                     </table>
                     </div>
                 </div>
                
              </div>
            </div>
            <!-- /.card -->
            
            <div class="card-footer">
                 <a href="/gms/user/list.do" class="btn btn-secondary float-left">취소</a>
		         <input type="button" id="save" value="저장"  class="btn btn-success float-right">
                </div>			
            </form>             	
        </div>
        
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
 
 
  </th:block>
  

  